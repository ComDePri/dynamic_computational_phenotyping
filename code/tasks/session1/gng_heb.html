<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Go or Withhold Game</title>
  <script src="jspsych-6.0.5/jspsych.js"></script>
  <script src="jspsych-6.0.5/plugins/jspsych-fullscreen.js"></script>
  <script src="jspsych-6.0.5/plugins/jspsych-instructions.js"></script>
  <script src="jspsych-6.0.5/plugins/jspsych-survey-text.js"></script>
  <script src="jspsych-6.0.5/plugins/jspsych-survey-multi-choice.js"></script>
  <script src="jspsych-6.0.5/plugins/jspsych-html-keyboard-response.js"></script>
  <script src="jspsych-6.0.5/plugins/jspsych-html-keyboard-response-gng.js"></script>
  <script src="jspsych-6.0.5/plugins/jspsych-image-keyboard-response.js"></script>
  <script src="jspsych-6.0.5/plugins/jspsych-html-button-response.js"></script>
  <script src="jspsych-6.0.5/plugins/jspsych-external-html.js"></script>
  <script src="jspsych-6.0.5/plugins/jspsych-call-function.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <link href="jspsych-6.0.5/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  <link rel='stylesheet' type='text/css' href='jspsych-6.0.5/css/jspsych.css'>
  <link rel="stylesheet" href="jspsych-6.0.5/css/jspsych.css"></link>
  <link rel="stylesheet" href="jspsych-6.0.5/css/style.css"></link>

  <style>
    .rtl-questions .jspsych-survey-multi-choice-question {
      direction: rtl;
      text-align: right;
    }
    .rtl-questions label {
      direction: rtl;
      display: inline-block;
    }
  </style>








</head>
<body dir="rtl">
</body>
<script>


  // quick change variables
  const BUCKET_NAME = 'gonogo-experiment-2025';
  var nextTask_name = "Escaping Dots Game";
  var nextTask_Id = "rdm";

  square_duration = 1000    //1000 from guitart-masip
  feedback_duration = 1000  //1000

  // loads images for squaare stimuli
  var squares = [ 'f1_1', 'f1_2', 'f1_3', 'f1_4', 'f2_1',  'f2_2',  'f2_3',  'f2_4',  'f3_1', 'f3_2', 'f3_3',  'f3_4',  'f4_1', 'f4_2',  'f4_3',  'f4_4', 'fsamp_1']

  // loads feedback images
  win_fb = "img/plus_points.jpg"
  lose_fb = "img/minus_points.jpg"
  neutral_fb = "img/no_points.jpg"

  prob_outcome = 80   // keep it a whole number
  reps_in_trial = 12  //reps_in_trial * 4 = actual number of reps in the trial/practice block (i.e. 15*4 = 60 )
  reps_in_exp = 20    // reps_in_exp * 4 = actual number of reps in the experimental blocks
  bonus_percent = 20/(reps_in_exp*2*4)// // 4*30*.8*0.33 --> max ~32
  fixed_bonus = 0     // 0
  error_rate_cap = 0.7 // if error rate is higher than error_rate_cap*100 percent, than a suspicion flag is triggered

  // start timeline
  var timeline = [];

  // add identifying information for primary key
  // weeks of participation
  var weekId = jsPsych.data.getURLVariable('weekId'); // change each week
  jsPsych.data.addProperties({
    weekId: weekId
  });

  // experiment Id: go no go task  = gng
  var expId = "gng_" + jsPsych.randomization.randomID(8);
  var eId = "gng"
  jsPsych.data.addProperties({
    expId: eId
  });

  // url
  var fullurl = window.location.href;
  jsPsych.data.addProperties({
    url: fullurl
  });

  // grabs turk info from the url
  var subjectId = jsPsych.data.getURLVariable('workerId');
  jsPsych.data.addProperties({
    subjectId: subjectId
  });

  // grabs turk info from the url
  var assignmentId = jsPsych.data.getURLVariable('assignmentId');
  jsPsych.data.addProperties({
    assignmentId: assignmentId
  });

  // grabs turk info from the url
  var hitId = jsPsych.data.getURLVariable('hitId');
  jsPsych.data.addProperties({
    hitId: hitId
  });

  // for teting purposes only
  // var subjectId = "hannatest"
  // jsPsych.data.addProperties({
  //   subjectId: subjectId
  // });
  //
  // var assignmentId = "abc"
  // jsPsych.data.addProperties({
  //   assignmentId: assignmentId
  // });
  //
  // var hitId = "123"
  // jsPsych.data.addProperties({
  //   hitId: hitId
  // });

  // fullscreen mode

  var fullscreen_intro = {
    type: 'instructions',
    pages: [
      "<div dir=\"rtl\"><p>במסך הבא תתבקשו להעביר את הדפדפן למצב מסך מלא.</p></div>" +
      "<div dir=\"rtl\"><p>לאחר שתעברו למסך מלא, חשוב שלא תצאו, לא תחליפו חלוניות, תמזערו או תשנו את הדפדפן שלכם עד סוף המשחק.</p></div>" +
      "<div dir=\"rtl\"><p>הפעולות הללו משנות את תצוגת המשחקף אך המשחק לא עוצר מרגע שההתחיל.</p></div>"
    ],
    show_clickable_nav: true,
    button_label_next: "הבא",
    button_label_previous: "הקודם",
    on_finish: function(data) {
      jsPsych.data.addDataToLastTrial({
        exp_stage:"fullscreen",
        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
        exp_part: "fullscreen"
      })
    }
  };
  timeline.push(fullscreen_intro)

  var fullscreen = {
    type: 'fullscreen',
    fullscreen_mode: true,
    message: "<p dir='rtl'>הניסוי יעבור כעת למסך מלא. לחצו על הכפתור כדי להמשיך.</p>",
    button_label: "המשך",
    on_finish: function(data) {
      jsPsych.data.addDataToLastTrial({
        exp_stage:"fullscreen",
        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
        exp_part: "fullscreen"
      })
    }
  };
  timeline.push(fullscreen)

  // instructions block

  var instructions = {
    type: 'instructions',
    pages: [
      '<div dir=\"rtl\"><p align=\'right\'>ברוכים הבאים למשחק &quot;ללחוץ או לא ללחוץ&quot;! המשחק אורך כ-20 דקות. לחצו על כפתור &quot;המשך&quot; כדי\n' +
      'למסך הבא</p></div>',
      "<div dir=\"rtl\"><p align='right'> במשחק שלושה סיבובים. בכל סיבוב יוצגו בפניכם תמונות בזו אחר זו. בכל פעם תוצג תמונה אחת מתוך ארבע תמונות אפשריות.</p></div>"+
      "<div dir=\"rtl\"><p align='right'> כאשר תראו תמונה, תצטרכו להחליט במהירות אם ללחוץ על מקש הרווח או לא ללחוץ.</p></div>"+
      "<div dir=\"rtl\"><p align='right'> המטרה שלכם היא ללמוד עבור אילו תמונות עליכם ללחוץ על מקש הרווח ועבור אילו תמונות עליכם להימנע מלחיצה. כדי ללמוד את הפעולה הנכונה, שימו לב מתי אתם זוכים בנקודות או מפסידים נקודות.</p></div>",
      "<div dir=\"rtl\"><p align='right'> שוב, המטרה שלכם היא ללמוד עבור אילו תמונות עליכם ללחוץ על מקש הרווח, ועבור אילו תמונות עליכם להימנע מלחיצה, באמצעות תשומת לב למצבים בהם אתם זוכים בנקודות (ניצחון), מפסידים נקודות (הפסד), או לא מקבלים נקודות כלל (נייטרלי).</p></div>" +
      "<div dir=\"rtl\"><p align='right'> במהלך כל סיבוב יהיו ארבעה סוגים שונים של תמונות: </p></div>" +
      "<div dir=\"rtl\"><p align='right'> ללחוץ כדי לזכות: במצב זה תרצו ללחוץ על מקש הרווח כדי לזכות בנקודות </p></div>" +
      "<div dir=\"rtl\"><p align='right'> לא-ללחוץ כדי לזכות: במצב זה תרצו להימנע מפעולה (לא ללחוץ על כלום) כדי לזכות בנקודות </p></div>" +
      "<div dir=\"rtl\"><p align='right'> ללחוץ כדי למנוע הפסד: במצב זה תרצו ללחוץ על מקש הרווח כדי למנוע הפסד של נקודות </p></div>" +
      "<div dir=\"rtl\"><p align='right'> לא-ללחוץ כדי למנוע הפסד: במצב זה תרצו להימנע מפעולה (לא ללחוץ על כלום) כדי למנוע הפסד של נקודות</p></div>",
      "<div dir=\"rtl\"><p align='right'>כדי להפוך את המשחק למאתגר, התמונות השונות יניבו את התוצאה הצפויה ברוב המקרים, אך לא בכולם </p></div>" +
      "<div dir=\"rtl\"><p align='right'>זכרו, יש ארבעה מצבים: ללחוץ כדי לזכות, לא-ללחוץ כדי לזכות, ללחוץ כדי להימנע מהפסד, לא-ללחוץ כדי להימנע מהפסד. </p></div>" +
      "<div dir=\"rtl\"><p align='right'> <b>עבור תמונות מסוג \"ללחוץ כדי לזכות\" או \"לא-ללחוץ כדי לזכות\", תקבלו נקודות (ניצחון) או שלא תקבלו נקודות (ניטרלי). </b></p></div>" +
      "<div dir=\"rtl\"><p align='right'> <b>עבור תמונות מסוג \"ללחוץ כדי למנוע הפסד\" או \"לא-ללחוץ כדי למנוע הפסד\", לא תקבלו שום נקודות (ניטרלי) או שתפסידו נקודות. </b></p></div>" +
      "<div dir=\"rtl\"><p align='right'> דוגמה, אם לחצתם נכון על מקש הרווח עבור תמונת ללחוץ כדי לזכות, יש סבירות גבוהה שתזכו בנקודות, אך ייתכן גם שלא תקבלו נקודות כלל. </p></div>" +
      "<div dir=\"rtl\"><p align='right'> אם נמנעתם נכון מלחיצה עבור תמונה מסוג \"לא-ללחוץ כדי למנוע הפסד\", יש סבירות גבוהה שתקבלו משוב ניטרלי, אך ייתכן גם שתאבדו נקודות. </p></div> ",

      "<div dir=\"rtl\"><p align='right'>כל תמונה תוצג למשך זמן קצר מאוד, לכן עליכם להחליט מהר ככל האפשר אם ללחוץ או לא-ללחוץ.</p></div>"+
      "<div dir=\"rtl\"><p align='right'> להלן דוגמה לסוג התמונה שתראו. </p></div>" +
      // example squares
      '<table style="margin-left:auto;margin-right:auto;table-layout:fixed !important; width:650px;"><tr>' +
      '<td><img src="img/go-nogo/stim/fsamp_1.png" style="width: 200px;"></td>' +
      '</tr><tr>' +
      '<td>תמונה לדוגמה</td>' +
      '</tr></table>',

      "<div dir=\"rtl\"><p align='right'>בכל פעם שתראו תמונה, עליכם להחליט אם ללחוץ על מקש הרווח או לא לפני שהתמונה נעלמת.</p></div>"+
      "<div dir=\"rtl\"><p align='right'> לאחר שהתמונה תיעלם, תראו אם זכיתם בנקודות, הפסקת נקודות, או אם לא קרה כלום (ניטרלי). המשוב יוצג באמצעות התמונות הבאות:</p></div>" +
      // win/lose/maintain feedback images
      '<table style="margin-left:auto;margin-right:auto;table-layout:fixed !important; width:650px;"><tr>' +
      '<td><img src=' + win_fb + ' style="width: 200px;"></td>' +
      '<td><img src=' + neutral_fb + ' style="height: 200px; "></td>' +
      '<td><img src=' + lose_fb + ' style="height: 200px; "></td>' +
      '</tr><tr>' +
      '<td>זכית בנקודת</td><td>נייטרלי</td><td>הפסדת נקודות</td>' +
      '</tr></table>',

      // "<p align='left'> ></p>" +
      // "<p align='left'> Every square has a correct reponse, and they do not change within the round. </p>" +
      // "<p align='left'> <i>Please note:</i> Sometimes, you will not lose points for making the incorrect response. </p>" +
      // "<p align='left'>  Sometimes, you will not earn points for making the correct response either. </p>" +
      // "<p align='left'> However, most of the time, a correct response will earn you points and an incorrect response will lose you points. </p>",

      // "<p align='left'>  <b> Some colors may be used twice in different rounds. The colors are randomly selected for each round and the color of a image in one round has no effect on it's answer in another round. </b></p>" +
      "<div dir=\"rtl\"><p align='right'>  במשחק תשלימו 3 סיבובים. כל סיבוב כולל סט שונה של ארבע תמונות, והן יוצגו " + reps_in_exp*4 + " פעמים. <div/></p> ",

      "<div dir=\"rtl\"><p align='right'> אנא השתדלו ללמוד את הפעולה המתאימה לכל תמונה ולבצע את המשימה כמיטב יכולתכם. הבונוס הכספי שתקבלו ייקבע בהתאם לנקודות שתצברו במהלך המשחק.</p></div>" +
      "<div dir=\"rtl\"><p align='right'> שימו לב כי אם תגיבו באופן אקראי, תמיד תלחצו, או לעולם לא תלחצו, אנו שומרים לעצמנו את הזכות לשלול את הבונוס שלכם. </p></div>",

      "<div dir=\"rtl\"><p align='right'>כעת, תשיבו על מספר שאלות בנוגע למשחק ולאחר מכן תעברו לתרגול קצר. </p></div>" +
      "<p>לחצו על \"המשך\" כדי לענות על שאלות הבנת ההוראות.</p></div>"
    ],
    show_clickable_nav: true,
    button_label_next: "הבא",
    button_label_previous: "הקודם",
    on_finish: function(data) {
      jsPsych.data.addDataToLastTrial({
        exp_stage:"instructions",
        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
        exp_part: "instructions"
      })
    }
  };
  timeline.push(instructions)


  // instruction comprehension questions
  var instruction_questions = {
    type: 'survey-multi-choice',
    questions: [
      {
        prompt: "איזו פעולה תבצעו במהלך המשחק?",
        options: [
          "אלחץ על כפתור שיוצג על המסך או אמתין (לא אלחץ על כלום)",
          "אלחץ על מקש הרווח או אמתין (לא אלחץ על כלום)",
          "אלחץ על החצים שמאלה או ימינה במקלדה כדי לציין את בחירתי",
          "אלחץ על החץ למעלה במקלדת או אמתין (לא אלחץ על כלום)"
        ]
      },
      {
        prompt: "בסיבוב יחיד, כמה תמונות שונות יוצגו?",
        options: ["1", "2", "3", "4"]
      }
    ],
    required: true,
    on_finish: function(data) {
      jsPsych.data.addDataToLastTrial({
        exp_stage: "instruction_questions",
        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
        exp_part: "instructions"
      });
    }
  };



  timeline.push(instruction_questions);

  // what they see if they answered one or both questions incorrectly the first time
  var redo_instructions = {
    type: 'instructions',
    pages: [
      "<p align='left'> הממ... בהתבסס על אחת או יותר מתשובותיכם לשאלות הקודמות, ייתכן שאינכם מבינים את המשימה באופן מלא. </p>" +
      "<p align='left'> אם לא תצליחו לענות נכון על השאלות שוב, אנו שומרים לעצמנו את הזכות לשלול את הבונוס שלכם, וייתכן שתתבקשו לעזוב את המחקר. </p>" +
      "<p align='left'> אנא לחצו על 'המשך' כדי לחזור להוראות. </p>"

    ],
    show_clickable_nav: true,
    button_label_next: "הבא",
    button_label_previous: "הקודם",
    on_finish: function(data) {
      jsPsych.data.addDataToLastTrial({
        exp_stage:"instruction_fail_first",
        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
        exp_part: "instructions"
      })
    },
  };

  // what they see if they answered one or both of the questions incorrectly more than once
  var failed_instructions = {
    type: 'instructions',
    pages: [
      "<p align='left'> מצטערים. נראה ששוב לא הצלחתם לענות נכונה על אחת או יותר משאלות ההבנה. </p>" +
      "<p align='left'> ייתכן שלא תקבלו בונוס כספי עבור ההשתתפות בניסוי. </p>" +
      "<p align='left'> <b> אם לא תצליחו להשיב על הוראות ההבנה בפעם השלישית ייתכן שנבקש מכם לעזוב את המחקר. </b></p>"
    ],
    show_clickable_nav: true,
    button_label_next: "הבא",
    button_label_previous: "הקודם",
    on_finish: function(data) {
      jsPsych.data.addDataToLastTrial({
        exp_stage:"instruction_fail_again",
        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
        exp_part: "instructions"
      })
    },
  };

  // evaluates question responses and loops timeline if questions are incorrect (part 3)
  // Note: you need all three parts (next two follow) for this function to work
  var instructions_understood3 = {
    timeline: [failed_instructions, instructions, instruction_questions],
    conditional_function:   function() {
      var dat = jsPsych.data.getLastTrialData().values()[0];
      var dat1 = jsPsych.data.getLastTrialData().values()[1];
      var answer1 = JSON.parse(dat.responses).Q0;
      var answer2 = JSON.parse(dat.responses).Q1;
      console.log(answer1);
      if(answer1.includes('הרווח') == true && answer2.includes('4') == true) {
        return false;
      } else {
        return true;
      }
    },
  };

  // evaluates question responses and loops timeline if questions are incorrect (part 2)
  var instructions_understood2 = {
    timeline: [failed_instructions, instructions, instruction_questions, instructions_understood3],
    conditional_function:   function() {
      var dat = jsPsych.data.getLastTrialData().values()[0];
      var dat1 = jsPsych.data.getLastTrialData().values()[1];
      var answer1 = JSON.parse(dat.responses).Q0;
      var answer2 = JSON.parse(dat.responses).Q1;
      if(answer1.includes('הרווח') == true && answer2.includes('4') == true) {
        return false;
      } else {
        return true;
      }
    },
  };

  // evaluates question responses and loops timeline if questions are incorrect (part 1)
  var instructions_understood = {
    timeline: [redo_instructions, instructions, instruction_questions, instructions_understood2],
    conditional_function:   function() {
      var dat = jsPsych.data.getLastTrialData().values()[0];
      var dat1 = jsPsych.data.getLastTrialData().values()[1];
      var answer1 = JSON.parse(dat.responses).Q0;
      var answer2 = JSON.parse(dat.responses).Q1;
      if(answer1.includes('הרווח') == true && answer2.includes('4') == true) {
        return false;
      } else {
        return true;
      }
    },
  };

  timeline.push(instructions_understood);

  // experiment helper functions

  function shuffler(listy){
    for(var i = 0; i < listy.length; i++){	// support function, shuffles a list
      var swpIdx = i + Math.floor(Math.random() * listy.length - i);
      var tmp = listy[i];
      listy[i] = listy[swpIdx];
      listy[swpIdx] = tmp;
    }
    return listy;
  }

  function make_stimuli(trial, stim, block_num) {  // generates the stimuli from the square images
    if (trial === true){
      stimulus = [
        {stimulus: 'img/go-nogo/stim/' + stim[0] + '.png', data: {color: stim[0], cond: 1, cond_name: 'go2win', correct_choice: 32, exp_part: 'practice', block: block_num}},
        {stimulus: 'img/go-nogo/stim/' + stim[1] + '.png', data: {color: stim[1], cond: 2, cond_name: 'noGo2win', correct_choice: null, exp_part: 'practice', block: block_num}},
        {stimulus: 'img/go-nogo/stim/' + stim[2] + '.png', data: {color: stim[2], cond: 3, cond_name: 'go2avoidPun', correct_choice: 32, exp_part: 'practice', block: block_num}},
        {stimulus: 'img/go-nogo/stim/' + stim[3] + '.png', data: {color: stim[3], cond: 4, cond_name: 'noGo2avoidPun', correct_choice: null, exp_part: 'practice', block: block_num}},
      ];
    }
    else{
      stimulus = [
        {stimulus: 'img/go-nogo/stim/' + stim[0] + '.png', data: {color: stim[0], cond: 1, cond_name: 'go2win', correct_choice: 32, exp_part: 'main', block: block_num}},
        {stimulus: 'img/go-nogo/stim/' + stim[1] + '.png', data: {color: stim[1], cond: 2, cond_name: 'noGo2win', correct_choice: null, exp_part: 'main', block: block_num}},
        {stimulus: 'img/go-nogo/stim/' + stim[2] + '.png', data: {color: stim[2], cond: 3, cond_name: 'go2avoidPun', correct_choice: 32, exp_part: 'main', block: block_num}},
        {stimulus: 'img/go-nogo/stim/' + stim[3] + '.png', data: {color: stim[3], cond: 4, cond_name: 'noGo2avoidPun', correct_choice: null, exp_part: 'main', block: block_num}},
      ];
    }
    return stimulus
  };

  // practice trial

  var start_trial = {
    type: 'html-keyboard-response',
    stimulus: '<p>סיבוב ניסיון,</p> <p>לחץ על כפתור להמשך</p>',
    on_finish: function(data) {
      jsPsych.data.addDataToLastTrial({
        exp_stage:"practice_start",
        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
        exp_part:"practice"
      })
    }
  }
  timeline.push(start_trial);

  // fixation pause
  var practice_fixation = {
    type: 'html-keyboard-response-gng',
    stimulus: '<div style="font-size:60px;">+</div>',
    choices: jsPsych.NO_KEYS,
    data: jsPsych.timelineVariable('data'),
    trial_duration: function(){
      return jsPsych.randomization.sampleWithoutReplacement([750, 900, 1050, 1200, 1350, 1500], 1)[0];
    },
    on_finish: function(data) {
      jsPsych.data.addDataToLastTrial({
        exp_stage:"practice_iti",
        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index
      })
    }
  }

  // choice
  var practice_test = {
    type: "image-keyboard-response",
    stimulus: jsPsych.timelineVariable('stimulus'),
    choices: [32],
    data: jsPsych.timelineVariable('data'),
    trial_duration: square_duration,
    on_finish: function(data){
      // choice label
      if (data.key_press == 32) {
        data.choice = "go"
      } else if (data.key_press == null) {
        data.choice = "nogo"
      } else {
        data.choice = "invalid"
      }
      // correct label & bonus pt allocation
      data.correct = data.key_press == data.correct_choice;
      var practice_correct = jsPsych.data.get().filter({correct: true, block: 'block_p'}).count()
      var all_correct = jsPsych.data.get().filter({correct: true}).count()
      data.curr_bonus = (all_correct - practice_correct)*bonus_percent
      data.trial_bonus = data.correct * bonus_percent
      // feedback determination
      random = Math.floor(Math.random()*100)
      // to-win conditions
      if ((data.cond == 1 || data.cond == 2) && data.correct == true) { // if it's go-to-win or no-go-to-win and they made correct choice
        if (random <= prob_outcome) { // if they fall in the 75% they get a reward
          data.outcome = 'win'
          data.feedback_points = 1
          data.probFall = prob_outcome //random number fell within the probability outcome
          data.fbExpected = true  //fbExpected means that they'll get the reward/punishment feedback that fits the expectation
        }
        else if (random> prob_outcome) {
          data.outcome = 'neutral' // if they fall in the 25% they get neutral
          data.feedback_points = 0
          data.probFall = 100 - prob_outcome
          data.fbExpected = false
        }
      } else if ((data.cond == 1 || data.cond == 2) && data.correct == false) { // if it's go-to-win or no-go-to-win and they made INcorrect choice
        if (random <= prob_outcome) { // if they fall in the 75% they get a neutral
          data.outcome = 'neutral'
          data.feedback_points = 0
          data.probFall = prob_outcome
          data.fbExpected = true
        }
        else if (random> prob_outcome) {
          data.outcome = 'win' // if they fall in the 25% they get reward
          data.feedback_points = 1
          data.probFall = 100 - prob_outcome
          data.fbExpected = false
        }
      }
      // to-avoid-punishment conditions
      if ((data.cond == 3 || data.cond == 4) && data.correct == true) { // if it's go-to-avoidPun or no-go-to-avoidPun and they made correct choice
        if (random <= prob_outcome) { // if they fall in the 75% they get a neutral
          data.outcome = 'neutral'
          data.feedback_points = 0
          data.probFall = prob_outcome
          data.fbExpected = true
        }
        else if (random> prob_outcome) {
          data.outcome = 'lose' // if they fall in the 25% they get punishment
          data.feedback_points = -1
          data.probFall = 100 - prob_outcome
          data.fbExpected = false
        }
      } else if ((data.cond == 3 || data.cond == 4) && data.correct == false) { // if it's go-to-avoidPun or no-go-to-avoidPun and they made INcorrect choice
        if (random <= prob_outcome) { // if they fall in the 75% they get a punishment
          data.outcome = 'lose'
          data.feedback_points = -1
          data.probFall = prob_outcome
          data.fbExpected = true
        }
        else if (random> prob_outcome) {
          data.outcome = 'neutral' // if they fall in the 25% they get neutral
          data.feedback_points = 0
          data.probFall = 100 - prob_outcome
          data.fbExpected = false
        }
      }
      // feedback pt allocation
      practice_agg_fb_pts = jsPsych.data.get().filter({block: "block_p"}).select('feedback_points').sum()
      data.agg_fb_pts = jsPsych.data.get().select('feedback_points').sum() - practice_agg_fb_pts

      jsPsych.data.addDataToLastTrial({
        exp_stage:"practice_choice",
        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index
      })
    },
  }


  // feedback
  var practice_feedback = {
    type: "image-keyboard-response",
    choices: jsPsych.NO_KEYS,
    trial_duration: feedback_duration,
    data: jsPsych.timelineVariable('data'),
    stimulus: function(){
      var outcome = jsPsych.data.get().last(1).values()[0].outcome;
      if (outcome === 'win'){
        return win_fb
      } else if (outcome === 'lose'){
        return lose_fb
      }
      else {
        return neutral_fb
      }
    },
    on_finish: function(data) {
      jsPsych.data.addDataToLastTrial({
        exp_stage:"practice_feedback",
        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index
      })
    }
  }

  // shuffler(squares)
  squares0 = ['f1_1', 'f1_2', 'f1_3', 'f1_4']
  stim0 = make_stimuli(true, shuffler(squares0), 'block_p')
  // practice trial all together
  var trial_procedure = {
    timeline: [practice_fixation, practice_test, practice_feedback],
    timeline_variables: stim0,
    repetitions: reps_in_trial,
    randomize_order: true
  }
  timeline.push(trial_procedure);

  // end of practice trial
  var end_trial = {
    type: 'html-keyboard-response',
    stimulus: '<p>This marks the end of the Practice Trial.</p> <p>Press any key to continue to the main experiment.</p>',
    on_finish: function(data) {
      uploadDataWithRetry()
      block_corr = jsPsych.data.get().last(3*4*reps_in_trial).filter({exp_stage: 'practice_choice', correct: true}).count()
      data.error_block = 1-(block_corr/(4*reps_in_trial))

      data.num_gos = jsPsych.data.get().last(3*4*reps_in_trial).filter({exp_stage: 'practice_choice', key_press: 32}).count()
      data.num_nogos = (4*reps_in_trial)-data.num_gos
      jsPsych.data.addDataToLastTrial({
        exp_stage:"practice_end",
        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
        suspicious: false,
        block: 'block_p',
        exp_part: "practice"
      })
    }
  }

  // if no suspicion flags were triggered
  var no_sus = {
    timeline: [end_trial],
    conditional_function:   function(data) {
      num_gos = jsPsych.data.get().last(3*4*reps_in_trial).filter({key_press: 32}).count()
      correct_oi = jsPsych.data.get().last(3*4*reps_in_trial).filter({correct: true}).count()
      error_rate = 1 - (correct_oi/(4*reps_in_trial))

      if(num_gos == reps_in_trial*4 || num_gos == 0) {
        return false;
      } else if (error_rate >= error_rate_cap){
        return false
      }
      else {
        return true;
      }
    }

  };
  timeline.push(no_sus);

  // if suspicion flags were triggered:
  var sus_1 = {
    type: 'instructions',
    pages: function(data){
      num_gos = jsPsych.data.get().last(3*4*reps_in_trial).filter({exp_stage: 'practice_choice', key_press: 32}).count()
      if (num_gos == reps_in_trial * 4) {
        return [
          "<p align='left'> הממ... לחצת על מקש הרווח עבור כל התמונות. נראה שאינך מבין/ה לגמרי את המשימה. </p>" +
          "<p align='left'> אם לא תצליח/י להשתפר בסיבוב התרגול הבא, אנו שומרים לעצמנו את הזכות לשלול את הבונוס שלך, וייתכן שתתבקש/י לעזוב את המחקר. </p>" +
          "<p align='left'> אנא לחץ/י על 'המשך' כדי לחזור להוראות. </p>"
        ];
      }
      else if (num_gos == 0) {
        return [
          "<p align='right'> הממ... לא לחצת כלל על מקש הרווח במהלך התרגול. נראה שאינך מבין/ה לגמרי את המשימה. </p>" +
          "<p align='right'> אם לא תצליח/י להשתפר בסיבוב התרגול הבא, אנו שומרים לעצמנו את הזכות לשלול את הבונוס שלך, וייתכן שתתבקש/י לעזוב את המחקר. </p>" +
          "<p align='right'> אנא לחץ/י על 'המשך' כדי לחזור להוראות. </p>"
        ];
      }
      else {
        return [
          "<p align='right'> הממ... דפוסי הלחיצה שלך על מקש הרווח (או הימנעות מהם) מעידים על כך שאולי לא הבנת לגמרי את המשימה. </p>" +
          "<p align='right'> אם לא תצליח/י להשתפר בסיבוב התרגול הבא, אנו שומרים לעצמנו את הזכות לשלול את הבונוס שלך, וייתכן שתתבקש/י לעזוב את המחקר. </p>" +
          "<p align='right'> אנא לחץ/י על 'המשך' כדי לחזור להוראות. </p>"
        ];
      }


    },
    show_clickable_nav: true,
    button_label_next: "הבא",
    button_label_previous: "הקודם",
    on_finish: function(data){
      data.primary_key =  subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index
      data.suspicious = true
      data.block = 'block_p'
      data.num_gos = num_gos
      data.num_nogos = (4*reps_in_trial)-num_gos
      data.exp_part = "instructions"

      data.exp_stage = "practice_suspicion_flag"
      if(num_gos == reps_in_trial*4) {
        data.suspicious_type = 'all_one';
      }
      else if (num_gos == 0) {
        data.suspicious_type = 'time_outs'
      }
      else {
        data.suspicious_type = 'error_rate'
      }
    }
  }

  var sus_2 = {
    type: 'instructions',
    pages: function(data){
      num_gos = jsPsych.data.get().last(3*4*reps_in_trial).filter({exp_stage: 'practice_choice', key_press: 32}).count()
      if (num_gos == reps_in_trial * 4) {
        return [
          "<p align='right'> הממ... לחצתם על מקש הרווח בכל פעם שהוצגה תמונה. נראה שאינכם מבינים לגמרי את המשימה. </p>" +
          "<p align='right'> אם לא תצליחו להשתפר בסיבוב התרגול הבא, אנו שומרים לעצמנו את הזכות לשלול את הבונוס שלכם, וייתכן שתתבקשו לעזוב את המחקר. </p>" +
          "<p align='right'> לחצו על 'המשך' כדי לחזור להוראות. </p>"
        ];
      }
      else if (num_gos == 0) {
        return [
          "<p align='right'> הממ... לא לחצתם כלל על מקש הרווח במהלך הצגת התמונות. נראה שאינכם מבינים לגמרי את המשימה. </p>" +
          "<p align='right'> אם לא תצליחו להשתפר בסיבוב התרגול הבא, אנו שומרים לעצמנו את הזכות לשלול את הבונוס שלכם, וייתכן שתתבקשו לעזוב את המחקר. </p>" +
          "<p align='right'> לחצו על 'המשך' כדי לחזור להוראות. </p>"
        ];
      }
      else {
        return [
          "<p align='right'> הממ... הבחירות שלכם מתי ללחוץ ומתי לא ללחוץ על מקש הרווח מרמזות שאינכם מבינים לגמרי את המשימה. </p>" +
          "<p align='right'> אם לא תצליחו להשתפר בסיבוב התרגול הבא, אנו שומרים לעצמנו את הזכות לשלול את הבונוס שלכם, וייתכן שתתבקשו לעזוב את המחקר. </p>" +
          "<p align='right'> לחצו על 'המשך' כדי לחזור להוראות. </p>"
        ];
      }



    },
    show_clickable_nav: true,
    button_label_next: "הבא",
    button_label_previous: "הקודם",
    on_finish: function(data){
      data.primary_key =  subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index
      data.suspicious = true
      data.block = 'block_p'
      data.num_gos = num_gos
      data.num_nogos = (4*reps_in_trial)-num_gos
      data.exp_stage = "practice_suspicion_flag"
      data.exp_part = "instructions"

      if(num_gos == reps_in_trial*4) {
        data.suspicious_type = 'all_one';
      }
      else if (num_gos == 0) {
        data.suspicious_type = 'time_outs'
      }
      else {
        data.suspicious_type = 'error_rate'
      }
    }
  }

  var final_bad = {
    type: 'instructions',
    pages: function(data){
      num_gos = jsPsych.data.get().last(3*4*reps_in_trial).filter({exp_stage: 'practice_choice', key_press: 32}).count()
      return [
        "<p align='left'> We're sorry, it appears as if you still do not fully understand the task. </p>" +
        "<p align='left'> We reserve the right to withold your bonus, and you may be asked to leave the study </p>" +
        "<p align='left'> Please click 'Next' to begin the main task. </p>"
      ]
    },
    show_clickable_nav: true,
    button_label_next: "הבא",
    button_label_previous: "הקודם",
    on_finish: function(data){
      data.primary_key =  subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index
      data.suspicious = true
      data.num_gos = num_gos
      data.num_nogos = (4*reps_in_trial)-num_gos
      data.block = 'block_p'
      data.exp_stage = "practice_suspicion_flag"
      data.exp_part = "instructions"

      if(num_gos == reps_in_trial*4) {
        data.suspicious_type = 'all_one';
      }
      else if (num_gos == 0) {
        data.suspicious_type = 'time_outs'
      }
      else {
        data.suspicious_type = 'error_rate'
      }
    }
  }

  var sus_procedure3 = {
    timeline: [final_bad],
    data: {exp_part: 'practice'},
    conditional_function:   function() {
      num_gos = jsPsych.data.get().last(3*4*reps_in_trial).filter({exp_stage: 'practice_choice', key_press: 32}).count()
      correct_oi = jsPsych.data.get().last(3*4*reps_in_trial).filter({correct: true}).count()
      error_rate = 1 - (correct_oi/(4*reps_in_trial))
      if(num_gos == reps_in_trial*4 || num_gos == 0) {
        return true;
      } else if (error_rate >= error_rate_cap){
        return true
      }
      else {
        return false;
      }
    },

  }

  var sus_procedure2 = {
    timeline: [sus_2, instructions, trial_procedure, no_sus, sus_procedure3],
    data: {exp_part: 'practice'},
    conditional_function:   function() {
      num_gos = jsPsych.data.get().last(3*4*reps_in_trial).filter({exp_stage: 'practice_choice', key_press: 32}).count()
      correct_oi = jsPsych.data.get().last(3*4*reps_in_trial).filter({correct: true}).count()
      error_rate = 1 - (correct_oi/(4*reps_in_trial))
      if(num_gos == reps_in_trial*4 || num_gos == 0) {
        return true;
      } else if (error_rate >= error_rate_cap){
        return true
      }
      else {
        return false;
      }
    },
  };

  var sus_procedure = {
    timeline: [sus_1, instructions, trial_procedure, no_sus, sus_procedure2],
    data: {exp_part: 'practice'},
    conditional_function:   function() {
      num_gos = jsPsych.data.get().last(3*4*reps_in_trial).filter({exp_stage: 'practice_choice', key_press: 32}).count()
      correct_oi = jsPsych.data.get().last(3*4*reps_in_trial).filter({correct: true}).count()
      error_rate = 1 - (correct_oi/(4*reps_in_trial))
      if(num_gos == reps_in_trial*4 || num_gos == 0) {
        return true;
      } else if (error_rate >= error_rate_cap){
        return true
      }
      else {
        return false;
      }
    },
  };

  timeline.push(sus_procedure);



  // main experiment

  // fixation pause
  var fixation = {
    type: 'html-keyboard-response-gng',
    stimulus: '<div style="font-size:60px;">+</div>',
    choices: jsPsych.NO_KEYS,
    data: jsPsych.timelineVariable('data'),
    trial_duration: function(){
      return jsPsych.randomization.sampleWithoutReplacement([750, 900, 1050, 1200, 1350, 1500], 1)[0];
    },
    on_finish: function(data) {
      jsPsych.data.addDataToLastTrial({
        exp_stage:"main_iti",
        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index
      })
    }
  }

  // choice
  var test = {
    type: "image-keyboard-response",
    stimulus: jsPsych.timelineVariable('stimulus'),
    choices: [32],
    data: jsPsych.timelineVariable('data'),
    trial_duration: square_duration,
    on_finish: function(data){
      // choice label
      if (data.key_press == 32) {
        data.choice = "go"
      } else if (data.key_press == null) {
        data.choice = "nogo"
      } else {
        data.choice = "invalid"
      }
      // correct label & bonus pt allocation
      data.correct = data.key_press == data.correct_choice;
      var practice_correct = jsPsych.data.get().filter({correct: true, block: 'block_p'}).count()
      var all_correct = jsPsych.data.get().filter({correct: true}).count()
      data.curr_bonus = (all_correct - practice_correct)*bonus_percent
      data.trial_bonus = data.correct * bonus_percent
      // feedback determination
      random = Math.floor(Math.random()*100)
      // to-win conditions
      if ((data.cond == 1 || data.cond == 2) && data.correct == true) { // if it's go-to-win or no-go-to-win and they made correct choice
        if (random <= prob_outcome) { // if they fall in the 75% they get a reward
          data.outcome = 'win'
          data.feedback_points = 1
          data.probFall = prob_outcome //random number fell within the probability outcome
          data.fbExpected = true  //fbExpected means that they'll get the reward/punishment feedback that fits the expectation
        }
        else if (random> prob_outcome) {
          data.outcome = 'neutral' // if they fall in the 25% they get neutral
          data.feedback_points = 0
          data.probFall = 100 - prob_outcome
          data.fbExpected = false
        }
      } else if ((data.cond == 1 || data.cond == 2) && data.correct == false) { // if it's go-to-win or no-go-to-win and they made INcorrect choice
        if (random <= prob_outcome) { // if they fall in the 75% they get a neutral
          data.outcome = 'neutral'
          data.feedback_points = 0
          data.probFall = prob_outcome
          data.fbExpected = true
        }
        else if (random> prob_outcome) {
          data.outcome = 'win' // if they fall in the 25% they get reward
          data.feedback_points = 1
          data.probFall = 100 - prob_outcome
          data.fbExpected = false
        }
      }
      // to-avoid-punishment conditions
      if ((data.cond == 3 || data.cond == 4) && data.correct == true) { // if it's go-to-avoidPun or no-go-to-avoidPun and they made correct choice
        if (random <= prob_outcome) { // if they fall in the 75% they get a neutral
          data.outcome = 'neutral'
          data.feedback_points = 0
          data.probFall = prob_outcome
          data.fbExpected = true
        }
        else if (random> prob_outcome) {
          data.outcome = 'lose' // if they fall in the 25% they get punishment
          data.feedback_points = -1
          data.probFall = 100 - prob_outcome
          data.fbExpected = false
        }
      } else if ((data.cond == 3 || data.cond == 4) && data.correct == false) { // if it's go-to-avoidPun or no-go-to-avoidPun and they made INcorrect choice
        if (random <= prob_outcome) { // if they fall in the 75% they get a punishment
          data.outcome = 'lose'
          data.feedback_points = -1
          data.probFall = prob_outcome
          data.fbExpected = true
        }
        else if (random> prob_outcome) {
          data.outcome = 'neutral' // if they fall in the 25% they get neutral
          data.feedback_points = 0
          data.probFall = 100 - prob_outcome
          data.fbExpected = false
        }
      }
      // feedback pt allocation
      practice_agg_fb_pts = jsPsych.data.get().filter({block: "block_p"}).select('feedback_points').sum()
      data.agg_fb_pts = jsPsych.data.get().select('feedback_points').sum() - practice_agg_fb_pts

      jsPsych.data.addDataToLastTrial({
        exp_stage:"main_choice",
        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index
      })
    },
  }

  // feedback page
  var feedback = {
    type: "image-keyboard-response",
    choices: jsPsych.NO_KEYS,
    trial_duration: feedback_duration,
    data: jsPsych.timelineVariable('data'),
    stimulus: function(){
      var outcome = jsPsych.data.get().last(1).values()[0].outcome;
      if (outcome === 'win'){
        return win_fb
      } else if (outcome === 'lose'){
        return lose_fb
      }
      else {
        return neutral_fb
      }
    },
    on_finish: function(data) {
      jsPsych.data.addDataToLastTrial({
        exp_stage:"main_feedback",
        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index
      })
    }
  }

  // which squares are used in which experimental block - pseudo randomly shuffled every week
  squares1 = ['f2_1', 'f2_2', 'f2_3', 'f2_4']
  squares2 = ['f3_1', 'f3_2', 'f3_3', 'f3_4']
  squares3 = ['f4_1', 'f4_2', 'f4_3', 'f4_4']

  // turn the square images into stimuli
  stim1 = make_stimuli(false, shuffler(squares1), 'block_1')
  stim2 = make_stimuli(false, shuffler(squares2), 'block_2')
  stim3 = make_stimuli(false, shuffler(squares3), 'block_3')
  stims = [[stim1, "one third"], [stim2, "two thirds"], [stim3]]

  // block 1
  for (i = 0; i < stims.length; i++){
    num = i+1
    var exp = {
      timeline: [fixation, test, feedback],
      timeline_variables: stims[i][0],
      repetitions: reps_in_exp,
      randomize_order: true
    }

    timeline.push(exp)
    if (stims[i].length == 2){
      timeline.push(between_block(stims[i][1]))

    }
  }

  // new block take a brief pause between
  function between_block(percent) {
    return {
      type: 'html-keyboard-response',
      stimulus: function() {
        var bonus = jsPsych.data.get().last(2).values()[0].curr_bonus;
        var rounded_bonus = Math.round(bonus)

        return ["<p>השלמתם " + percent + " מהמשחק והרווחתם <b>"+ rounded_bonus + "</b> נקודות בונוס בסך הכל!</p>"+
        "<p>תוכלו לקחת הפסקה קצרה של כמה שניות, אך לא יותר מזה. </p>"+
        "<p>לחצו על מקש כלשהו כדי להמשיך.</p>"];
      },
      trial_duration: 60000,
      response_ends_trial: true,
      on_finish: function(data) {
        uploadDataWithRetry();
        var curr_block = jsPsych.data.get().last(2).values()[0].block;
        data.num_gos = jsPsych.data.get().filter({key_press: 32, exp_stage: 'main_choice', block: curr_block}).count()
        data.num_nogos = jsPsych.data.get().filter({key_press: null, exp_stage: 'main_choice', block: curr_block}).count()
        // data.num_nogos = (2*reps_in_exp)- data.num_gos

        num_trials = jsPsych.data.get().filter({exp_stage: 'main_choice', block: curr_block}).count()

        ttl_correct = jsPsych.data.get().filter({exp_stage: 'main_choice', correct: true, block: curr_block}).count()
        error_rate = 1 - (ttl_correct/num_trials)
        data.error_block = error_rate

        num_trials = jsPsych.data.get().filter({exp_stage: 'main_choice', block: curr_block}).count()

        if (data.num_gos == num_trials){
          data.suspicious_type = 'all_one'
          data.suspicious = true
        }
        else if (data.num_gos == 0){
          data.suspicious_type = 'time_outs'
          data.suspicious = true
        }
        else if (error_rate >= error_rate_cap){
          data.suspicious_type = 'error_rate'
          data.suspicious = true
        }
        else{
          data.suspicious = false
        }
        data.block = curr_block // defines as this block after the filtering to determine num gos
        data.exp_part = 'main'

        jsPsych.data.addDataToLastTrial({
          exp_stage:"between_block",
          primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index
        })
      }
    }
  };

  // end of exp - tell them what they made in terms of bonus points
  var bonus_block = {
    type: 'instructions',
    pages: function() {
      var bonus = jsPsych.data.get().last(2).values()[0].curr_bonus
      var rounded_bonus = Math.round(bonus)
      if (rounded_bonus < fixed_bonus){
        rounded_bonus = fixed_bonus
      }

      return ['<p>הניסוי הסתיים</p>' +
      '<p>הרווחתם <b>' + rounded_bonus + ' נקודת בונוס </b>!</p>' +
      '<p>תודה רבה שהשתתפתם.</p>' +
      '<p>לחצו <q>המשך</q> כדי לעבור לשאלון המשוב</p>'];
    },
    show_clickable_nav: true,
    button_label_next: "הבא",
    button_label_previous: "הקודם",
    on_finish: function(data) {
      var curr_block = jsPsych.data.get().last(2).values()[0].block;
      data.num_gos = jsPsych.data.get().filter({key_press: 32, exp_stage: 'main_choice', block: curr_block}).count()
      data.num_nogos = jsPsych.data.get().filter({key_press: null, exp_stage: 'main_choice', block: curr_block}).count()
      // data.num_nogos = (2*reps_in_exp)- data.num_gos

      num_trials = jsPsych.data.get().filter({exp_stage: 'main_choice', block: curr_block}).count()

      ttl_correct = jsPsych.data.get().filter({exp_stage: 'main_choice', correct: true, block: curr_block}).count()
      error_rate = 1 - (ttl_correct/num_trials)
      data.error_block = error_rate


      if (data.num_gos == num_trials){
        data.suspicious_type = 'all_one'
        data.suspicious = true
      }
      else if (data.num_gos == 0){
        data.suspicious_type = 'time_outs'
        data.suspicious = true
      }
      else if (error_rate >= error_rate_cap){
        data.suspicious_type = 'error_rate'
        data.suspicious = true
      }
      else{
        data.suspicious = false
      }
      data.block = curr_block // defines as this block after the filtering to determine num gos
      data.exp_part = 'main'

      jsPsych.data.addDataToLastTrial({
        exp_stage:"end_bonus",
        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index
      })
    }
  };
  timeline.push(bonus_block);
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


  // if they triggered a suspicion flag

  var fb_warning_ss = {
    type: 'instructions',
    pages: [
      "<p align='left'> המשחק כולל מספר בדיקות מובנות שנועדו לבדוק האם השחקנים לא הצליחו להשלים את המטלה" +
      "<p align='left'> (למשל, אם הם בחרו תמיד באותה פעולה או לא בחרו באף פעולה). " +
      "<p align='left'>  משהו בתגובות שלך עבור חלק או כל המשימה הזו הפעיל אחת מההתראות האלה." ,

      "<p align='left'>  הבונוס שלך יבוטל עד שנסיין יוכל לבדוק ידנית את התשובות שלך כדי לבדוק אם הייתה טעות מצדנו" +
      "<p align='left'>  בשאלון המשוב הבא תוכלו להסביר אם קרה משהו שבגללו תגובותיכם עלולות להיראות שגויות. " +
      "<p align='left'>  במקרה של טעות או של שגיאה מצדנו, תקבלו את הבונוס כמתכונן." +
      "<p align='left'>  עם זאת, אם יתברר שניסיתם \"לעבוד\" על המערכת, אנחנו שומרים על הזכות לא להעניק בונוס."
    ],
    show_clickable_nav: true,
    button_label_next: "הבא",
    button_label_previous: "הקודם",
    on_finish: function(data) {
      jsPsych.data.addDataToLastTrial({
        fb_type: "suspicious",
        exp_stage:"feedback_warning",
        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
        exp_part: "feedback"
      })
    }
  };

  // first question - tech problems
  var fb_q1_ss = {
    type: 'survey-multi-choice',
    preamble: '<h4> שאלון משוב 1/4 </h4>', //+
    //"<h5 align='left'> אנא השיבו בכנות., <u> תשבותיכם לא ישפיעו על הבונוס עבור הניסוי. </u> </h5>",
    questions: [
      {prompt: "האם נתקלתם בקושי טכני במהלך המשחק? (למשל, האם הניסוי נתקע, נסגר באמצע וכו').\n" +
                "אם תבחרו \"כן\" או \"לא בטוח\" תינתן לכם האפשרות לפרט.\n",
        options: [" כן", " לא", " לא בטוח"],
        // horizontal: true,
        required: true,
        name: 'tech problems'},
    ],
    on_finish: function(data){
      var dat1 = jsPsych.data.getLastTrialData().values()[0];
      var answer1 = JSON.parse(dat1.responses).Q0;
      if(answer1.includes('כן') == true || answer1.includes('לא בטוח')) {
        jsPsych.data.addDataToLastTrial({
          fb_type: "suspicious",
          fb_issue:'tech',
          exp_stage:"feedback_tech",
          primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
          exp_part: "feedback"
        })
      } else {
        jsPsych.data.addDataToLastTrial({
          fb_type: "suspicious",
          exp_stage:"feedback_tech",
          primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
          exp_part: "feedback"
        })
      }
    }
  };

  // first question - tech problems - if yes, please explain
  var fb_q1_follow_ss = {
    type: 'survey-text',
    preamble: '<h4> שאלון משוב 1/4 </h4>', // +
    questions: [
      {prompt: "אנא ספרו לנו על הקשיים הטכניים שנתקלתם בהם. ",
        required: true,
        name: 'tech problems follow up'},
    ],
    on_finish: function(data){
      var dat1 = jsPsych.data.getLastTrialData().values()[0];
      var answer1 = JSON.parse(dat1.responses).Q0;
      jsPsych.data.addDataToLastTrial({
        fb_type: "suspicious",
        fb_issue: 'tech',
        fb_issue_txt: answer1,
        exp_stage:"feedback_tech_followup",
        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
        exp_part: "feedback"
      })
    }
  };

  // determines if subject answered yes, and explanation is required
  var fb_q1_eval_ss = {
    timeline: [fb_q1_follow_ss],
    conditional_function:   function() {
      var dat1 = jsPsych.data.getLastTrialData().values()[0];
      var answer1 = JSON.parse(dat1.responses).Q0;
      if(answer1.includes('כן') == true || answer1.includes('לא בטוח')) {
        return true;
      } else {
        return false;
      }
    },
  };


  // second question - distractions
  var fb_q2_ss = {
    type: 'survey-multi-choice',
    preamble: '<h4> שאלון משוב 2/4 </h4>', // +
    questions: [{
      prompt: "האם חוויתם הסחת דעת משמעותית במהלך המשחק?\n" +
              "אם תבחרו \"כן\" תינתן לכם האפשרות לפרט.\n",
      options: [" כן", " לא"],
      required: true,
      name: 'distractions'
    },
    ],
    on_finish: function(data){
      var dat2 = jsPsych.data.getLastTrialData().values()[0];
      var answer2 = JSON.parse(dat2.responses).Q0;
      if(answer2.includes('כן') == true) {
        jsPsych.data.addDataToLastTrial({
          fb_type: "suspicious",
          fb_issue:'distraction',
          exp_stage:"feedback_distraction",
          primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
          exp_part: "feedback"
        })
      } else {
        jsPsych.data.addDataToLastTrial({
          fb_type: "suspicious",
          exp_stage:"feedback_distraction",
          primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
          exp_part: "feedback"
        })
      }
    }
  };

  // second question - distractions - if yes, please explain
  var fb_q2_follow_ss = {
    type: 'survey-text',
    preamble: '<h4> Feedback Survey 2/4 </h4>', // +
    questions: [
      {prompt: "אנא תאר אילו הסחות דעת השפיעה על הביצועים שלך, ואם אפשר, באיזה שלב במשימה חווית זאת:",
        name: 'tech problems follow up'},
    ],
    on_finish: function(data){
      var dat2 = jsPsych.data.getLastTrialData().values()[0];
      var answer2 = JSON.parse(dat2.responses).Q0;
      jsPsych.data.addDataToLastTrial({
        fb_type: "suspicious",
        fb_issue: 'distraction',
        fb_issue_txt: answer2,
        exp_stage:"feedback_distraction_followup",
        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
        exp_part: "feedback"
      })
    }
  };

  // determines if subject answered yes, and explanation is required
  var fb_q2_eval_ss = {
    timeline: [fb_q2_follow_ss],
    conditional_function:   function() {
      var dat2 = jsPsych.data.getLastTrialData().values()[0];
      var answer2 = JSON.parse(dat2.responses).Q0;
      if(answer2.includes('כו') == true) {
        return true;
      } else {
        return false;
      }
    },
  };


  // third question: engagement
  var fb_q3_ss = {
    type: 'survey-multi-choice',
    preamble: '<h4> שאלון משוב 3/4 </h4>', // +
    questions: [{
      prompt: "בסולם מ- 1 עד 4, באיזו מידה המשחק גרם לכם להיות מרוכזים בו (עד כמה הוא תפס את תשומת לבכם)?",
      options: [" 1. כלל לא גרם לריכוז", " 2. יחסית לא גרם לריכוז", " 3. גרם למידה מסוימת של ריכוז", " 4. גרם לריכוז רב"],
      required: true,
      name: 'engagement'
    },
    ],
    on_finish: function(data){
      var dat3 = jsPsych.data.getLastTrialData().values()[0];
      var answer3 = JSON.parse(dat3.responses).Q0;
      jsPsych.data.addDataToLastTrial({
        fb_type: "suspicious",
        fb_engagement: answer3,
        exp_stage:"feedback_engaged",
        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
        exp_part: "feedback"
      })
    }
  };

  // fourth question: anything else
  var fb_q4_ss = {
    type: 'survey-text',
    preamble: '<h4> שאלון משוב 4/4 </h4>', // +
    questions: [{
      prompt: "האם תרצו לחלוק איתנו משהו נוסף? (דאגה ספציפית, הצעה כללית לשיפור וכו')",
      name: 'anything else'
    },
    ],
    on_finish: function(data){

      var interaction_data = jsPsych.data.getInteractionData();
      data.screen = interaction_data.json();

      var dat4 = jsPsych.data.getLastTrialData().values()[0];
      var answer4 = JSON.parse(dat4.responses).Q0;
      if (answer4 == ''){
        jsPsych.data.addDataToLastTrial({
          fb_type: "suspicious",
          exp_stage:"feedback_other",
          fb_type: "suspicious",
          primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
          exp_part: "feedback"
        })
      } else {
        jsPsych.data.addDataToLastTrial({
          fb_type: "suspicious",
          fb_issue: 'other',
          fb_issue_txt: answer4,
          exp_stage:"feedback_other",
          primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
          exp_part: "feedback"
        })
      }
    }
  };

  // conclusion
  var fb_end_exp_ss = {
    type: 'html-keyboard-response',
    stimulus: '<p>תודה! שאלון המשוב הסתיים.</p>' +
            ' <p>לחצו על מקש כלשהו כדי לסיים את הניסוי.</p>',
    on_finish: function(data) {

      var interaction_data = jsPsych.data.getInteractionData();
      data.screen = interaction_data.json();

      jsPsych.data.addDataToLastTrial({
        fb_type: "suspicious",
        exp_stage:"exp_end",
        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
        exp_part: "feedback"
      })
    }
  };


  // not suspicious

  var fb_warning_ns = {
    type: 'instructions',
    pages: [
      "<p align='left'> המשחק כולל מספר בדיקות מובנות שנועדו לבדוק האם השחקנים לא הצליחו להשלים את המטלה" +
      "<p align='left'> (למשל, אם הם בחרו תמיד באותה פעולה או לא בחרו באף פעולה). " +

      "<p align='left'>  תגובותיך ייבדקו על ידי החוקרים, אך נראה שהתאמצת להשלים את המטלה. תודה רבה!" +
      "<p align='left'>  בשאלון המשוב הבא תוכלו להסביר אם קרה משהו שבגללו תגובותיכם עלולות להיראות שגויות. " +
      "<p align='left'>  במקרה של טעות או של שגיאה מצדנו, תקבלו את הבונוס כמתכונן." +
      "<p align='left'>  עם זאת, אם יתברר שניסיתם \"לעבוד\" על המערכת, אנחנו שומרים על הזכות לא להעניק בונוס."
    ],
    show_clickable_nav: true,
    button_label_next: "הבא",
    button_label_previous: "הקודם",
    on_finish: function(data) {
      jsPsych.data.addDataToLastTrial({
        fb_type: "nonsuspicious",
        exp_stage:"feedback_warning",
        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
        exp_part: "feedback"
      })
    }
  };

  // first question - tech problems
  var fb_q1_ns = {
    type: 'survey-multi-choice',
    preamble: '<h4> שאלון משוב 1/4 </h4>' +
    "<h5 align='left'> אנא השיבו בכנות., <u> תשבותיכם לא ישפיעו על הבונוס עבור הניסוי. </u> </h5>",
    questions: [
      {
        prompt: "האם נתקלתם בקושי טכני במהלך המשחק? (למשל, האם הניסוי נתקע, נסגר באמצע וכו').\n" +
                "אם תבחרו \"כן\" או \"לא בטוח\" תינתן לכם האפשרות לפרט.\n",
        options: [" כן", " לא", " לא בטוח"],
        // horizontal: true,
        required: true,
        name: 'tech problems'
      },
    ],
    on_finish: function (data) {
      var dat1 = jsPsych.data.getLastTrialData().values()[0];
      var answer1 = JSON.parse(dat1.responses).Q0;
      if (answer1.includes('כן') == true || answer1.includes('לא בטוח')) {
        if (answer1.includes('כן') == true || answer1.includes('לא בטוח')) {
          jsPsych.data.addDataToLastTrial({
            fb_type: "nonsuspicious",
            fb_issue: 'tech',
            exp_stage: "feedback_tech",
            primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
            exp_part: "feedback"
          })
        } else {
          jsPsych.data.addDataToLastTrial({
            fb_type: "nonsuspicious",
            exp_stage: "feedback_tech",
            primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
            exp_part: "feedback"

          })
        }
      }
    }
  }

    // first question - tech problems - if yes, please explain
    var fb_q1_follow_ns = {
      type: 'survey-text',
      preamble: '<h4> שאלון משוב 1/4 </h4>' +
              "<h5 align='left'> אנא השיבו בכנות., <u> תשבותיכם לא ישפיעו על הבונוס עבור הניסוי. </u> </h5>",
      questions: [
        {prompt: "אנא ספרו לנו על הקשיים הטכניים שנתקלתם בהם. ",
          required: true,
          name: 'tech problems follow up'},
      ],
      on_finish: function(data){
        var dat1 = jsPsych.data.getLastTrialData().values()[0];
        var answer1 = JSON.parse(dat1.responses).Q0;
        jsPsych.data.addDataToLastTrial({
          fb_type: "nonsuspicious",
          fb_issue: 'tech',
          fb_issue_txt: answer1,
          exp_stage:"feedback_tech_followup",
          primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
          exp_part: "feedback"
        })
      }
    };

    // determines if subject answered yes, and explanation is required
    var fb_q1_eval_ns = {
      timeline: [fb_q1_follow_ns],
      conditional_function:   function() {
        var dat1 = jsPsych.data.getLastTrialData().values()[0];
        var answer1 = JSON.parse(dat1.responses).Q0;
        if(answer1.includes('כן') == true || answer1.includes('לא בטוח')) {
          return true;
        } else {
          return false;
        }
      },
    };


// second question - distractions
    var fb_q2_ns = {
      type: 'survey-multi-choice',
      preamble: '<h4> שאלון משוב 2/4 </h4>' +
              "<h5 align='left'> אנא השיבו בכנות., <u> תשבותיכם לא ישפיעו על הבונוס עבור הניסוי. </u> </h5>",
      questions: [{
        prompt: "האם חוויתם הסחת דעת משמעותית במהלך המשחק?\n" +
                "אם תבחרו \"כן\" תינתן לכם האפשרות לפרט.\n",
        options: [" כן", " לא"],
        required: true,
        name: 'distractions'
      },
      ],
      on_finish: function(data){
        var dat2 = jsPsych.data.getLastTrialData().values()[0];
        var answer2 = JSON.parse(dat2.responses).Q0;
        if(answer2.includes('כן') == true) {
          jsPsych.data.addDataToLastTrial({
            fb_type: "nonsuspicious",
            fb_issue:'distraction',
            exp_stage:"feedback_distraction",
            primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
            exp_part: "feedback"
          })
        } else {
          jsPsych.data.addDataToLastTrial({
            fb_type: "nonsuspicious",
            exp_stage:"feedback_distraction",
            primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
            exp_part: "feedback"
          })
        }
      }
    };

    // second question - distractions - if yes, please explain
    var fb_q2_follow_ns = {
      type: 'survey-text',
      preamble: '<h4> שאלון משוב 2/4 </h4>' +
              "<h5 align='left'> אנא השיבו בכנות., <u> תשבותיכם לא ישפיעו על הבונוס עבור הניסוי. </u> </h5>",
      questions: [
        {prompt: "אנא תאר אילו הסחות דעת השפיעה על הביצועים שלך, ואם אפשר, באיזה שלב במשימה חווית זאת:",
          name: 'tech problems follow up'},
      ],
      on_finish: function(data){
        var dat2 = jsPsych.data.getLastTrialData().values()[0];
        var answer2 = JSON.parse(dat2.responses).Q0;
        jsPsych.data.addDataToLastTrial({
          fb_type: "nonsuspicious",
          fb_issue: 'distraction',
          fb_issue_txt: answer2,
          exp_stage:"feedback_distraction_followup",
          primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
          exp_part: "feedback"
        })
      }
    };

    // determines if subject answered yes, and explanation is required
    var fb_q2_eval_ns = {
      timeline: [fb_q2_follow_ns],
      conditional_function:   function() {
        var dat2 = jsPsych.data.getLastTrialData().values()[0];
        var answer2 = JSON.parse(dat2.responses).Q0;
        if(answer2.includes('כן') == true) {
          return true;
        } else {
          return false;
        }
      },
    };


// third question: engagement
    var fb_q3_ns = {
      type: 'survey-multi-choice',
      preamble: '<h4> שאלון משוב 3/4 </h4>' +
              "<h5 align='left'> אנא השיבו בכנות., <u> תשבותיכם לא ישפיעו על הבונוס עבור הניסוי. </u> </h5>",
      questions: [{
        prompt: "בסולם מ- 1 עד 4, באיזו מידה המשחק גרם לכם להיות מרוכזים בו (עד כמה הוא תפס את תשומת לבכם)?",
        options: [" 1. כלל לא גרם לריכוז", " 2. יחסית לא גרם לריכוז", " 3. גרם למידה מסוימת של ריכוז", " 4. גרם לריכוז רב"],
        required: true,
        name: 'engagement'
      },
      ],
      on_finish: function(data){
        var dat3 = jsPsych.data.getLastTrialData().values()[0];
        var answer3 = JSON.parse(dat3.responses).Q0;
        jsPsych.data.addDataToLastTrial({
          fb_type: "nonsuspicious",
          fb_engagement: answer3,
          exp_stage:"feedback_engaged",
          primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
          exp_part: "feedback"
        })
      }
    };

// fourth question: anything else
    var fb_q4_ns = {
      type: 'survey-text',
      preamble: '<h4> שאלון משוב 4/4 </h4>' +
              "<h5 align='left'> אנא השיבו בכנות., <u> תשבותיכם לא ישפיעו על הבונוס עבור הניסוי. </u> </h5>",
      questions: [{
        prompt: "האם תרצו לחלוק איתנו משהו נוסף? (דאגה ספציפית, הצעה כללית לשיפור וכו')",
        name: 'anything else'
      },
      ],
      on_finish: function(data){

        var interaction_data = jsPsych.data.getInteractionData();
        data.screen = interaction_data.json();

        var dat4 = jsPsych.data.getLastTrialData().values()[0];
        var answer4 = JSON.parse(dat4.responses).Q0;
        if (answer4 == ''){
          jsPsych.data.addDataToLastTrial({
            fb_type: "nonsuspicious",
            exp_stage:"feedback_other",
            primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
            exp_part: "feedback"
          })
        } else {
          jsPsych.data.addDataToLastTrial({
            fb_type: "nonsuspicious",
            fb_issue: 'other',
            fb_issue_txt: answer4,
            exp_stage:"feedback_other",
            primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
            exp_part: "feedback"
          })
        }
      }
    };

// conclusion - if its not the last experiment in the battery
    var fb_end_exp_ns = {
      type: 'html-keyboard-response',
      stimulus: '<p>תודה! שאלון המשוב הסתיים.</p>' +
              ' <p>לחצו על מקש כלשהו כדי לסיים את הניסוי.</p>',
      on_finish: function(data) {

        var interaction_data = jsPsych.data.getInteractionData();
        data.screen = interaction_data.json();

        jsPsych.data.addDataToLastTrial({
          exp_stage:"exp_end",
          primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
          exp_part: "feedback"
        })
      }
    };

// timeline push


// evaluate whether any of the responses were suspicious and provide appropriate quiz

    var eval_ss_timeline = {
      timeline: [fb_warning_ss, fb_q1_ss, fb_q1_eval_ss, fb_q2_ss, fb_q2_eval_ss, fb_q3_ss, fb_q4_ss, fb_end_exp_ss],
      // timeline: [fb_warning_ss, fb_q1_ss, fb_q1_eval_ss, fb_q2_ss, fb_q2_eval_ss, fb_q3_ss, fb_q4_ss], // uncomment if it is the last experiment in battery
      conditional_function: function(data) {
        sus_dat = jsPsych.data.get().filter({exp_part: 'main', suspicious: true}).count()
        if (sus_dat >= 1) {
          return true;
        } else {
          return false;
        }
      },
    };
    timeline.push(eval_ss_timeline);

    var eval_ns_timeline = {
      timeline: [fb_warning_ns, fb_q1_ns, fb_q1_eval_ns, fb_q2_ns, fb_q2_eval_ns, fb_q3_ns, fb_q4_ns, fb_end_exp_ns],
      // timeline: [fb_warning_ns, fb_q1_ns, fb_q1_eval_ns, fb_q2_ns, fb_q2_eval_ns, fb_q3_ns, fb_q4_ns], // uncomment if it is the last experiment in battery
      conditional_function: function(data) {
        if (sus_dat == 0) {
          return true;
        } else {
          return false;
        }
      },
    };
    timeline.push(eval_ns_timeline);

    // Save data to CSV
    function saveData_csv(name, data){
    var xhr = new XMLHttpRequest();
    xhr.open('POST', 'save_data.php');
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.send(JSON.stringify({filename: name, filedata: data}));
  }

  var save_data = {
    type: 'call-function',
    func: function(){ saveData_csv(subjectId + '_' + weekId + '_' + expId, jsPsych.data.get().csv());
    },
    timing_post_trial: 0,
    on_finish: function(data) {
      jsPsych.data.addDataToLastTrial({
        exp_stage:"save_CSV",
        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
        exp_part: "save"
      })
    }
  };
  timeline.push(save_data);
  console.log('csv save successful')

  // "dashboard"
  var dash_to_task = {
    type: "html-button-response",
    stimulus:
            '<div id="blue"> ' +
            '<div id="title">' +
            "<h1>DASHBOARD</h1>" +
            "<h3>If you need to take a brief rest between tasks please do so now.</h3>" +
            "<h2>Click the button below to proceed to the next task.</h2>" +
            "<h4>Note: you will not be paid for the time you spend on this page.</h4>" +
            "</div> " +
            "</div>",
    button_html: '<button style="height:75px;width:400px;background-color:powderblue">%choice%</button>',
    choices: ["<h1>" + nextTask_name + "</h1>"],
    on_finish: function(data) {

      var interaction_data = jsPsych.data.getInteractionData();
      data.screen = interaction_data.json();

      jsPsych.data.addDataToLastTrial({
        exp_stage:"dashboard",
        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
        task_selected: nextTask_Id,
        exp_part: "dash"
      })
    }
  }
  timeline.push(dash_to_task)



  // database save

  function saveData() {
    var xhr = new XMLHttpRequest();
    xhr.open('POST', 'write_data_gng.php'); // change 'write_data.php' to point to php script.
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.onload = function() {
      console.log('xhr response text coming up')
      console.log(xhr.responseText);
      if(xhr.status == 200){
        var response = JSON.parse(xhr.responseText);
        console.log(xhr.responseText);
        console.log(response.success);
      }
    };
    xhr.send(jsPsych.data.get().json());
    console.log('function finished well')
  };

  var db_save = {
    type: 'call-function',
    func: uploadDataWithRetry(true),
    on_finish: function(data) {
      jsPsych.data.addDataToLastTrial({
        exp_stage:"save_database",
        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
        exp_part: "save"
      })
    }
  };
  timeline.push(db_save)



  // data saving + compensation code
  var save_wait_1 = {
    type: 'html-keyboard-response',
    stimulus: "<p> You're doing great!</p>" +
            '<p> Please wait about 30 seconds while we save your data and load the next game.</p>' +
            '<p> You will be automatically redirected to the next page momentarily.</p>',
    choices: [jsPsych.NO_KEYS],
    trial_duration: 30000,
    response_ends_trial: false,
    on_finish: function(data) {
      jsPsych.data.addDataToLastTrial({
        exp_stage:"save_wait",
        primary_key: subjectId + '_' + weekId + '_' + expId + '_' + data.trial_index,
        exp_part: "save"
      })
    }
  };

  timeline.push(save_wait_1)


  // init experiment

  jsPsych.init({
    timeline: timeline,
    on_finish: function() {window.location.href = "pre_rdm.html" + '?workerId=' + subjectId + '&hitId=' + hitId + '&assignmentId=' + assignmentId}
    // on_finish: function() {     // for testing purposes
    //   jsPsych.data.displayData();
    //   jsPsych.data.get().localSave('csv','gng_0_CSV.csv');
    // },
  });


  function uploadDataWithRetry(lastTry=false, endTest=true ,retryCount = 5, delay = 1000) {
    let subject = subjectId;
    let results = jsPsych.data.get().json();

    return new Promise((resolve, reject) => {
      function attemptUpload(remainingRetries) {
        $.ajax({
          url: 'https://hss74dd1ed.execute-api.us-east-1.amazonaws.com/dev/',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({
            "subject_id": `${subject}`,
            "bucket": `${BUCKET_NAME}`,
            "exp_data": JSON.stringify(results, null, 2)
          }),
          success: function(response) {
            console.log('Data uploaded successfully:', response);
            resolve(response);
            if(endTest) {
              //window.location.href = getRedirectionUrl();
            }
          },
          error: function(xhr, status, error) {
            console.error(`Error uploading data (${remainingRetries} retries left):`, error);
            if (remainingRetries > 0) {
              setTimeout(() => {
                attemptUpload(remainingRetries - 1);
              }, delay);
            }
          }
        });
      }

      attemptUpload(retryCount);
    });
  }

</script>

</html>
